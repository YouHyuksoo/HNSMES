# Phase 3: 전체 시스템 데이터 흐름도

## 3.1 시스템 아키텍처 개요

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRESENTATION LAYER                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   WinForms  │  │  WinForms   │  │  WinForms   │  │   Reports   │        │
│  │  (PRDA201)  │  │  (MATA201)  │  │  (SYSA201)  │  │  (RPTA201)  │        │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        │
│         │                │                │                │               │
│         └────────────────┴────────────────┴────────────────┘               │
│                                    │                                        │
│                    DevExpress 13.2 (XtraGrid, XtraEditors)                  │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │
┌────────────────────────────────────▼────────────────────────────────────────┐
│                         BUSINESS LOGIC LAYER                                 │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    IDatabaseProcess (Interface)                      │   │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌───────────────┐  │   │
│  │  │WCFDatabaseProcess│    │WSDatabaseProcess│    │DirectCon (Oracle)│  │   │
│  │  │  (TCP:8101)     │    │  (HTTP:8807)    │    │  (Barcode용)   │  │   │
│  │  └────────┬────────┘    └────────┬────────┘    └───────┬───────┘  │   │
│  └───────────┼──────────────────────┼─────────────────────┼──────────┘   │
│              │                      │                     │               │
│              ▼                      ▼                     ▼               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      WebService.Access Layer                         │   │
│  │    WCFServiceProcess        WebServiceProcess      WSResults       │   │
│  └───────────────────────────────┬─────────────────────────────────────┘   │
└──────────────────────────────────┼──────────────────────────────────────────┘
                                   │
┌──────────────────────────────────▼──────────────────────────────────────────┐
│                        DATA ACCESS LAYER                                     │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    WCF Server / WebService Server                    │   │
│  │                           (10.2.31.9)                                │   │
│  │                              │                                      │   │
│  │                              ▼                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │              Oracle Database (10.2.30.7:1522)                │   │   │
│  │  │                   Service: CDBHNSMES                         │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3.2 핵심 데이터 흐름

### 3.2.1 로그인 프로세스 흐름

```
┌─────────┐     ┌─────────────┐     ┌──────────────────┐     ┌─────────────┐
│  User   │────▶│  COMLOGIN   │────▶│  IDatabaseProcess│────▶│  Oracle DB  │
│         │     │   (Form)    │     │   Execute_Proc   │     │             │
└─────────┘     └──────┬──────┘     └──────────────────┘     └──────┬──────┘
                       │                                             │
                       │  1. 입력: 사용자ID, 비밀번호                 │
                       │     ↓                                        │
                       │  2. PKGSYS_USER.CHK_USER 호출               │
                       │     ↓                                        │
                       │  3. 사용자정보 조회                          │
                       │     ↓                                        │
                       │  4. 비밀번호 검증 (Decrypt)                 │
                       │     ↓                                        │
                       │  5. Global_Variable에 세션 저장             │
                       │     ↓                                        │
                       │  6. 메인화면 로드                            │
                       │                                              │
                       ▼                                              ▼
              ┌─────────────┐                              ┌─────────────┐
              │ MainForm    │◀────────────────────────────│  Menu/Role  │
              │  (Tile UI)  │     PKGSYS_MENU.GET_MENU    │  권한체크   │
              └─────────────┘                              └─────────────┘
```

**세션 정보 저장 변수:**
```csharp
Global_Variable.USER_ID      // 사용자ID
Global_Variable.USERROLE     // 권한그룹
Global_Variable.DEPTCODE     // 부서코드
Global_Variable.CLIENT       // 클라이언트(1060)
Global_Variable.COMPANY      // 회사(40)
Global_Variable.PLANT        // 공장(P200)
```

---

### 3.2.2 생산실적 등록 흐름 (PRDA201)

```
사용자 입력
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           PRDA201 Form                                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 작업지시 │  │  바코드  │  │  실적수  │  │  양/불   │  │  저장    │  │
│  │  스캔   │  │  스캔   │  │   입력   │  │  판정   │  │  버튼   │  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  │
└───────┼─────────────┼─────────────┼─────────────┼─────────────┼──────────┘
        │             │             │             │             │
        └─────────────┴─────────────┴─────────────┴─────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     Data Validation & Processing                         │
│  - 바코드 유효성 체크 (PKGPRD_PROD.CHK_BARCODE)                         │
│  - 중복실적 체크 (PKGPRD_PROD.CHK_DUPLICATE)                            │
│  - 공정체크 (PKGPRD_PROD.CHK_OPERATION)                                 │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         Transaction Processing                           │
│                                                                          │
│  Step 1: PKGPRD_PROD.SET_WORK_RESULT (실적저장)                         │
│     ├── TW_PRODHIST INSERT (생산이력)                                   │
│     ├── TM_SERIAL UPDATE (시리얼 상태변경)                              │
│     └── TH_STOCKSERIAL UPDATE (재고차감)                                │
│                                                                          │
│  Step 2: PKGTXN_STOCK.SET_STOCK_DEDUCT (자재차감)                       │
│     └── TW_OUT INSERT (자재출고이력)                                    │
│                                                                          │
│  Step 3: PKGPRD_QC.CHK_DEFECT (불량처리)                                │
│     └── TW_BRD INSERT (불량이력)                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 3.2.3 자재 입고 프로세스 (MATA201)

```
┌─────────────┐
│   입고접수   │◀── 수주/발주 기반 입고예정
└──────┬──────┘
       │
       ▼
┌─────────────┐     ┌──────────────────────────────────────┐
│  바코드스캔  │────▶│ PKGPDA_MAT.CHK_VENDORPARTNO          │
│  (Lot No)   │     │ - 거래처/품번 일치여부 체크          │
└──────┬──────┘     └──────────────────────────────────────┘
       │
       ▼
┌─────────────┐     ┌──────────────────────────────────────┐
│   IQC검사   │────▶│ PKGMAT_INOUT.SET_IQC_JUDGE           │
│  (수량/판정)│     │ - 검사결과 저장                      │
└──────┬──────┘     │ - 합격/불합격 판정                   │
       │            └──────────────────────────────────────┘
       │
       ▼
┌─────────────┐     ┌──────────────────────────────────────┐
│  라벨발행   │────▶│ PKGMAT_INOUT.SET_NEW_CREATESN        │
│ (Serial 생성)│     │ - TM_SERIAL INSERT                   │
└──────┬──────┘     │ - 바코드 라벨 생성                   │
       │            └──────────────────────────────────────┘
       │
       ▼
┌─────────────┐     ┌──────────────────────────────────────┐
│   입고처리   │────▶│ PKGPDA_MAT.SET_RECEIVE               │
│             │     │ - TW_IN INSERT (입고이력)            │
└──────┬──────┘     │ - TH_STOCKSERIAL INSERT (재고생성)   │
       │            └──────────────────────────────────────┘
       │
       ▼
┌─────────────┐
│   입고완료   │
└─────────────┘
```

---

### 3.2.4 재고 관리 흐름

```
┌────────────────────────────────────────────────────────────────────────────┐
│                            재고 테이블 구조                                 │
│                                                                            │
│   TH_STOCKSERIAL (현재고)                                                  │
│   ├── SERIALNO (시리얼번호)                                                │
│   ├── ITEMCODE (품목코드)                                                  │
│   ├── QTY (수량)                                                           │
│   ├── WHCODE (창고코드)                                                    │
│   ├── LOCCODE (로케이션)                                                   │
│   └── STATUS (상태: 정상/불량/품질보류)                                     │
│                                                                            │
│   TW_IN (입고이력) ◀── 입고처리                                            │
│   TW_OUT (출고이력) ◀── 출고/생산투입                                      │
│   TW_PRODHIST (생산이력) ◀── 생산실적                                      │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘

재고변동 흐름:

입고:  TW_IN INSERT ──▶ TH_STOCKSERIAL INSERT
출고:  TW_OUT INSERT ──▶ TH_STOCKSERIAL UPDATE (QTY 차감)
생산:  TW_PRODHIST INSERT ──▶ TH_STOCKSERIAL UPDATE
```

---

## 3.3 모듈 간 데이터 연계

### 3.3.1 모듈 의존성 다이어그램

```
                    ┌─────────────┐
                    │     SYS     │
                    │  (시스템)   │
                    │ 사용자/메뉴/권한│
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│     MST     │    │     MAT     │    │     PRD     │
│  (기준정보)  │◀───│  (자재관리)  │◀───│  (생산관리)  │
│ 품목/거래처  │    │ 입출고/재고  │    │ 작업실적    │
│ BOM/공정    │    │ IQC/OQC     │    │ 생산현황    │
└──────┬──────┘    └──────┬──────┘    └──────┬──────┘
       │                  │                  │
       │    ┌─────────────┴─────────────┐   │
       │    │                           │   │
       ▼    ▼                           ▼   ▼
┌──────────────────────────────────────────────────┐
│                    RPT (리포트)                   │
│            생산일보/재고현황/품질현황             │
└──────────────────────────────────────────────────┘
```

### 3.3.2 테이블 간 관계

```
마스터 ────────────────────────────────────────────────────────────

[TM_CLIENT]
    │
    ├── [TM_COMPANY]
    │       │
    │       ├── [TM_PLANT]
    │       │       │
    │       │       ├── [TM_WAREHOUSE] ─── [TM_LOCATION]
    │       │       │
    │       │       ├── [TM_PRODLINE] ──── [TM_PRODLINE_UNIT]
    │       │       │
    │       │       └── [TM_ITEMS] ─────── [TM_BOM] ─── [TM_BOMGRP]
    │       │
    │       ├── [TM_VENDOR]
    │       │
    │       ├── [TM_USER] ─── [TM_USERROLE]
    │       │
    │       └── [TM_DEPARTMENT]
    │
    └── [TM_SYSTEM]


트랜잭션 ───────────────────────────────────────────────────────────

[TM_SERIAL] ◀── 시리얼마스터
    │
    ├── [TW_IN] ◀── 입고이력
    │
    ├── [TW_OUT] ◀── 출고이력
    │
    ├── [TW_PRODHIST] ◀── 생산이력
    │       │
    │       └── [TW_PRODHIST_USE] ◀── 자재사용이력
    │
    └── [TH_STOCKSERIAL] ◀── 현재고


품질 ──────────────────────────────────────────────────────────────

[TW_IQC] ◀── 수입검사
    │
[TW_OQC] ◀── 출하검사
    │
[TW_BRD] ◀── 불량등록
    │
[TH_CRIMPINSP] ◀── 크림핑검사
```

---

## 3.4 주요 업무별 시퀀스 다이어그램

### 3.4.1 작업지시 → 생산실적 → 재고차감

```sequence
User->PRDA201: 작업지시 스캔
PRDA201->DB: PKGPRD_PROD.GET_WORKORDER
DB-->PRDA201: 작업지시정보

User->PRDA201: 바코드 스인
PRDA201->DB: PKGPRD_PROD.CHK_BARCODE
DB-->PRDA201: 품목정보

User->PRDA201: 실적저장 클릭
PRDA201->WCF: Execute_Proc(PKGPRD_PROD.SET_WORK_RESULT)
WCF->DB: BEGIN TRANSACTION

DB->DB: INSERT TW_PRODHIST
DB->DB: UPDATE TM_SERIAL
DB->DB: PKGTXN_STOCK.SET_STOCK_DEDUCT
DB->DB: INSERT TW_OUT (자재차감)
DB->DB: UPDATE TH_STOCKSERIAL

DB-->WCF: COMMIT
WCF-->PRDA201: WSResults(ResultInt=0)
PRDA201-->User: 저장완료 메시지
```

### 3.4.2 입고 → IQC → 라벨발행

```sequence
User->MATA201: 입고접수
MATA201->DB: PKGMAT_INOUT.GET_IQC_LIST
DB-->MATA201: 입고대상목록

User->MATA201: Lot 스캔
MATA201->DB: PKGPDA_MAT.CHK_VENDORPARTNO
DB-->MATA201: 품번정보

User->MATA201: 검사결과 입력
MATA201->DB: PKGMAT_INOUT.SET_IQC_JUDGE
DB-->MATA201: IQC결과저장

User->MATA201: 라벨발행
MATA201->DB: PKGMAT_INOUT.SET_NEW_CREATESN
DB->DB: INSERT TM_SERIAL
DB-->MATA201: Serial 생성완료

MATA201-->User: 라벨 프린트
```

---

## 3.5 인터페이스 연계

### 3.5.1 ERP 연계 (PKGIF_ERP)

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   HNSMES    │      │   PKGIF_ERP │      │    ERP      │
│   (Oracle)  │◀────▶│  (Package)  │◀────▶│   (SAP)     │
│             │      │             │      │             │
│ TW_IN       │      │ GET_ERP_PO  │      │ PO Interface│
│ TW_OUT      │      │ PUT_ERP_GR  │      │ GR Interface│
│ TM_ITEMS    │      │ SYNC_ITEM   │      │ Master I/F  │
└─────────────┘      └─────────────┘      └─────────────┘

연계방식: DB Link 또는 WebService
```

### 3.5.2 PDA 연계 (PKGPDA_*)

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│    PDA      │      │   MES DB    │      │   WCF       │
│  (Android)  │◀────▶│  (Oracle)   │◀────▶│  (8101)     │
│             │      │             │      │             │
│ 수입검사    │◀───▶│ PKGPDA_MAT  │◀────▶│ Service     │
│ 자재입고    │◀───▶│ PKGPDA_PROD │◀────▶│ Host        │
│ 생산실적    │◀───▶│ PKGPDA_COMM │◀────▶│             │
└─────────────┘      └─────────────┘      └─────────────┘
```

---

## 3.6 데이터 백업 및 이력 관리

### 3.6.1 이력 테이블 분류

| 구분 | 테이블 패턴 | 보관기간 | 설명 |
|------|------------|---------|------|
| **트랜잭션** | TW_* | 3년 | 입출고, 생산실적 |
| **히스토리** | TH_* | 5년 | 재고변경이력 |
| **로그** | TL_* | 1년 | 사용자로그 |
| **월별집계** | *_MONTH | 영구 | 월별집계데이터 |

### 3.6.2 데이터 Archiving

```
TW_PRODHIST (3년이상) ──▶ TW_PRODHIST_HIS (백업)
TW_OUT (3년이상) ───────▶ TW_OUT_HIS (백업)
TH_USESYSTEMLOG ────────▶ Partition별 삭제
```

---

## 다음 단계

Phase 4에서는 다음을 진행합니다:
1. 화면별 상세 기능 정의서 작성
2. 주요 프로시저 기능 명세서
3. ERD 상세 다이어그램
